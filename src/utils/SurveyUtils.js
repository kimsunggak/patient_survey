// ì—­ì½”ë”©ì´ í•„ìš”í•œ ë¬¸í•­ ë²ˆí˜¸ ë°°ì—´
// exportëŠ” í•´ë‹¹ íŒŒì¼ ë‚´ì—ì„œ ì„ ì–¸í•œ ë³€ìˆ˜ë‚˜ í•¨ìˆ˜ë¥¼ ë‹¤ë¥¸ íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ë‹¤ ì“¸ ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ê²ƒ
export const reverseIds = [1,2,3,4,5,6,7,8,18,19,20,21,22,23,24,25,26,27,28];
// ì—­ì½”ë”© í•¨ìˆ˜
export function reverseScore(score, max=5, min=1) {
    return max + min - score;
  }
// ì—¬ëŸ¬ ë¬¸í•­ì— ì—­ì½”ë”©ì„ ì ìš©í•˜ëŠ” í•¨ìˆ˜
export function applyReverseScore(answers) {
    // ì—­ì½”ë”© ëœ ê²°ê³¼ë¥¼ ë‹´ì„ ê°ì²´
    const result = {};
    // answers ë§¤ê°œë³€ìˆ˜ê°€ {'1': '3', '2': '4', ...} ì²˜ëŸ¼ ì§ˆë¬¸ ID : ë‹µë³€ ê°’ í˜•íƒœë¡œ ë˜ì–´ìˆëŠ” ê°œì²´ë¼ê³  ê°€ì •
    // Object.entries() ë©”ì„œë“œëŠ” ê°ì²´ì˜ í‚¤-ê°’ ìŒì„ ë°°ì—´ë¡œ ë°˜í™˜
    for (const [qid, value] of Object.entries(answers)) {
        // qidê°€ 'q1' í˜•íƒœë©´ ìˆ«ìë§Œ ì¶”ì¶œ
        const numId = Number(qid.replace(/^q/, ""));
        result[qid] = reverseIds.includes(numId) ? reverseScore(Number(value)) : Number(value);
    }
    return result;
}

// ì ìˆ˜ ë³€í™˜ í•¨ìˆ˜
export const SectionStats =  {
    "ì•” ì´í›„ ë‚´ ëª¸ì˜ ë³€í™”": { mean: 3.09, sd: 0.95 },
    "ê±´ê°•í•œ ì‚¶ì„ ìœ„í•œ ê´€ë¦¬": { mean: 3.63, sd: 0.76 },
    "íšŒë³µì„ ë„ì™€ì£¼ëŠ” ì‚¬ëŒë“¤": { mean: 3.84, sd: 0.94 },
    "ì‹¬ë¦¬ì  ë¶€ë‹´": { mean: 3.08, sd: 0.91 },
    "ì‚¬íšŒì  ì‚¶ì˜ ë¶€ë‹´": { mean: 3.39, sd: 1.20 },
    "ì•” ì´í›„ íƒ„ë ¥ì„±": { mean: 4.28, sd: 0.72 },
    "ì „ì²´ í‰ê·  (ì•” ìƒì¡´ì ê±´ê°•ê´€ë¦¬)": { mean: 3.46, sd: 0.65 }
  };
export function newScore(sectionName, userScore) {
    const stat = SectionStats[sectionName];
    if (!stat) return null;
    const z_score = (userScore - stat.mean) / stat.sd;
    return Math.round((z_score * 16.67) + 50);
}
// ì ìˆ˜ë³„ ì§‘ë‹¨ ë¶„ë¥˜ í•¨ìˆ˜
export function getRiskGroup(sectionName, meanScore) {
    const stat = SectionStats[sectionName];
    if (!stat) return null;
    // ì„¹ì…˜ë³„ ì ìˆ˜ ì§€í‘œ ê°€ì ¸ì™€ì„œ cut-off score ê³„ì‚°
    const cutoff = stat.mean - stat.sd;
    if (meanScore <= cutoff) return "ê³ ìœ„í—˜ì§‘ë‹¨";
    if (meanScore <= stat.mean) return "ì£¼ì˜ì§‘ë‹¨";
    return "ì €ìœ„í—˜ì§‘ë‹¨";
  }
// ì„¤ë¬¸ì¡°ì‚¬ ê²°ê³¼(ì§‘ë‹¨)ì— ë”°ë¥¸ ê³ ì • ì½”ë©˜íŠ¸ 
export const Comments = {
  patient: {
    "ê³ ìœ„í—˜ì§‘ë‹¨": "ğŸ©ºê²€ì‚¬ ê²°ê³¼ë¥¼ ë³´ë‹ˆ ë„ì›€ì´ í•„ìš”í•´ ë³´ì—¬ìš”. í˜¹ì‹œ ë¶ˆí¸í•œ ì ì´ ìˆìœ¼ë©´ ì–¸ì œë“  í¸í•˜ê²Œ ì „ë¬¸ê°€ì™€ ìƒë‹´í•´ ë³´ì„¸ìš”. í•¨ê»˜ ê³ì—ì„œ ë„ì™€ë“œë¦´ê²Œìš”â¤ï¸",
    "ì£¼ì˜ì§‘ë‹¨": "ì£¼ê¸°ì ì¸ ì ê²€ê³¼ ê´€ì‹¬ì´ í•„ìš”í•©ë‹ˆë‹¤. ê±´ê°• ìƒíƒœë¥¼ ê¾¸ì¤€íˆ í™•ì¸í•´ ì£¼ì„¸ìš”.ğŸ˜Š",
    "ì €ìœ„í—˜ì§‘ë‹¨": "í˜„ì¬ ì–‘í˜¸í•œ ìƒíƒœë¥¼ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤ğŸŒŸ ì§€ê¸ˆì²˜ëŸ¼ ê±´ê°•ì„ ì˜ ê´€ë¦¬í•´ ì£¼ì„¸ìš”.ê³„ì† ì‘ì›í• ê²Œìš”ğŸ‰ğŸ‘"
  },
  socialWorker: {
    "ê³ ìœ„í—˜ì§‘ë‹¨": "í™˜ìê°€ ê³ ìœ„í—˜ì§‘ë‹¨ì— í•´ë‹¹í•©ë‹ˆë‹¤. ì¶”ê°€ì ì¸ ê°œì… ë° ì „ë¬¸ ìƒë‹´ ì—°ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤.",
    "ì£¼ì˜ì§‘ë‹¨": "í™˜ìê°€ ì£¼ì˜ì§‘ë‹¨ì— í•´ë‹¹í•©ë‹ˆë‹¤. ì •ê¸°ì ì¸ ëª¨ë‹ˆí„°ë§ê³¼ ì˜ˆë°©ì  ì§€ì›ì´ ê¶Œì¥ë©ë‹ˆë‹¤.",
    "ì €ìœ„í—˜ì§‘ë‹¨": "í™˜ìê°€ ì €ìœ„í—˜ì§‘ë‹¨ì— í•´ë‹¹í•©ë‹ˆë‹¤. í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•  ìˆ˜ ìˆë„ë¡ ì§€ì†ì ì¸ ê²©ë ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤."
  }
};
// ë©”ì¸ ì½”ë©˜íŠ¸ë§Œ ë°˜í™˜
export function getPatientComment(group) {
  return Comments.patient[group] || "";
}
// ì¶”ê°€ ì•ˆë‚´ ì½”ë©˜íŠ¸ ë°˜í™˜
export function getPatientExtraComment(reason12_1) {
  const commentConditions = [
    "ë¬´ì—‡ì„ í•´ì•¼ í• ì§€ ëª°ë¼ì„œ",
    "ê±´ê°•ê´€ë¦¬ ìì²´ë¥¼ ìŠ¤íŠ¸ë ˆìŠ¤ë¼ê³  ìƒê°í•´ì„œ",
    "ì˜ì§€ê°€ ì—†ì–´ì„œ"
  ];
  if (
    Array.isArray(reason12_1) &&
    reason12_1.some(r => {
      // ì•ì˜ ë²ˆí˜¸ì™€ ê´„í˜¸, ê³µë°±ì„ ì œê±°í•˜ê³  ë¹„êµ
      const cleaned = r.replace(/^[0-9]+\)\s*/, "");
      return commentConditions.includes(cleaned);
    })
  ) {
    return "ì°¸ì—¬ìë‹˜ì€ ì‚¬íšŒë³µì§€ì‚¬ë‚˜ ìƒë‹´ê°€ì™€ì˜ ìƒë‹´ì„ ê°•ë ¥ ê¶Œì¥í•©ë‹ˆë‹¤ğŸš¨";
  }
  return "";
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   0) ë²ˆí˜¸Â·ê´„í˜¸ ì œê±° ìœ í‹¸ (12-1ìš©)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const stripPrefix = (s = "") => s.replace(/^[0-9]+\)\s*/, "");

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   0) 13-1 í•˜ìœ„ ë¬¸í•­ ë©”íƒ€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const SUB13 = [
  { id:'q13_1_1', text:'ì¡°ë¯¸ë£Œ ì„­ì·¨ë¥¼ ì¤„ì¸ë‹¤.',            comment:"ë‚˜íŠ¸ë¥¨Â·ì¡°ë¯¸ë£Œ ì„­ì·¨ë¥¼ ì¡°ê¸ˆ ë” ì¤„ì—¬ ë³´ì„¸ìš”." },
  { id:'q13_1_2', text:'ì‹í’ˆì˜ ì‹ ì„ ë„ë¥¼ ì¤‘ìš”ì‹œí•œë‹¤.',      comment:"ì‹ ì„ í•œ ì‹ì¬ë£Œë¥¼ ì„ íƒí•˜ë©´ ê±´ê°•ì— ë„ì›€ì´ ë©ë‹ˆë‹¤!" },
  { id:'q13_1_3', text:'ì±„ì‹ ë° ê³¼ì¼ ìœ„ì£¼ì˜ ì‹ìŠµê´€ì„ í•œë‹¤.', comment:"ğŸ¥— ì±„ì†ŒÂ·ê³¼ì¼ ì„­ì·¨ë¥¼ ëŠ˜ë ¤ ë³´ì„¸ìš”." },
  { id:'q13_1_4', text:'ìœ¡ë¥˜ ì„­ì·¨ë¥¼ ì¡°ì ˆí•œë‹¤.',            comment:"ë¶‰ì€ ê³ ê¸° ì„­ì·¨ë¥¼ ì¤„ì´ê³ , ì‚´ì½”ê¸°Â·ì–´ë¥˜ë¡œ ëŒ€ì²´í•´ ë³´ì„¸ìš”." },
  { id:'q13_1_5', text:'íƒ„ìˆ˜í™”ë¬¼ ì„­ì·¨ë¥¼ ì¡°ì ˆí•œë‹¤.',        comment:"ì •ì œ íƒ„ìˆ˜í™”ë¬¼ ëŒ€ì‹  í†µê³¡ë¬¼ì„ ì„ íƒí•´ ë³´ì„¸ìš”." },
  { id:'q13_1_6', text:'í•­ì•”ì‹í’ˆì„ ë¨¹ëŠ”ë‹¤.',               comment:"í•­ì•”ì‹í’ˆì„ ê¾¸ì¤€íˆ ì„­ì·¨í•´ ë³´ì„¸ìš”." }
];

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1) ì •ì  ë£° (Q10, Q12-1 ë“±)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const BASE_RULES = [
  { id:'exercise',
    condition:a=>[1,2].includes(Number(a.q10)),
    comment:"ğŸ’ª ê·œì¹™ì ì¸ ìš´ë™ì„ í•´ë³´ì„¸ìš”! ê°€ë²¼ìš´ ê±·ê¸°ë¶€í„° ì‹œì‘í•´ë„ ì¢‹ì•„ìš”.",
    style:"info" }
];

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   2) 13-1 ë™ì  ë£° ìƒì„±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const DIET_RULES = SUB13.map(({ id, comment }) => ({
  id,
  condition: (a) => {
    const v = Number(a[id]);        // 1~5ì 
    return v && v <= 3;             // 1Â·2Â·3ì´ë©´ true
  },
  comment,
  style: "warning"
}));

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   3) ìµœì¢… ë£° í…Œì´ë¸”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const FEEDBACK_RULES = [
  /* ìƒë‹´ ê¶Œì¥ ë£° (id: counselling) */
  {
    id: "counselling",
    condition: (a, _mean, risk) => {
      // 1) 12-1 ì´ìœ  ì¡°ê±´
      const reason12 = Array.isArray(a.q12_reasons) &&
        ["ë¬´ì—‡ì„ í•´ì•¼ í• ì§€ ëª°ë¼ì„œ",
         "ê±´ê°•ê´€ë¦¬ ìì²´ë¥¼ ìŠ¤íŠ¸ë ˆìŠ¤ë¼ê³  ìƒê°í•´ì„œ",
         "ì˜ì§€ê°€ ì—†ì–´ì„œ"]
        .some(t => a.q12_reasons.map(s=>s.replace(/^[0-9]+\)\s*/,""))
          .includes(t));

      // 2) ì„¹ì…˜4(ì‹¬ë¦¬ì  ë¶€ë‹´) ê³ ìœ„í—˜
      const psychHigh = risk?.psychologicalBurden === "ê³ ìœ„í—˜ì§‘ë‹¨";

      return reason12 || psychHigh;          // ë‘˜ ì¤‘ í•˜ë‚˜ë©´ true
    },
    comment: "ì°¸ì—¬ìë‹˜ì€ ì‚¬íšŒë³µì§€ì‚¬ë‚˜ ìƒë‹´ê°€ì™€ì˜ ìƒë‹´ì„ ê°•ë ¥ ê¶Œì¥í•©ë‹ˆë‹¤ğŸš¨",
    style: "error"
  },
  /* ì„¹ì…˜ 6(ì•” ì´í›„ íƒ„ë ¥ì„±) ì „ìš© RULES */
  // 6-A. ê³ ìœ„í—˜ì§‘ë‹¨
  {
    id: "resilience_high",
    condition: (answers, _mean, risk) =>
      risk?.resilience === "ê³ ìœ„í—˜ì§‘ë‹¨",
    comment:
      "ğŸš¨ íšŒë³µ íƒ„ë ¥ì„±ì´ ë‚®ê²Œ í‰ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ì™€ ìƒì˜í•´ ì‹¬ë¦¬Â·ì •ì„œì  ì§€ì›ì„ ë°›ì•„ë³´ì„¸ìš”!",
    style: "error"
  },
  // 6-B. ì£¼ì˜ì§‘ë‹¨
  {
    id: "resilience_mid",
    condition: (answers, _mean, risk) =>
      risk?.resilience === "ì£¼ì˜ì§‘ë‹¨",
    comment:
      "ğŸ’ª íšŒë³µ íƒ„ë ¥ì„±ì„ ë†’ì¼ ìˆ˜ ìˆë„ë¡ ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ì™€ ê·œì¹™ì ì¸ ìƒí™œì— ì¡°ê¸ˆ ë” í˜ì¨ë³´ì„¸ìš”!",
    style: "warning"
  },
  // 6-C. ì €ìœ„í—˜ì§‘ë‹¨
  {
    id: "resilience_low",
    condition: (answers, _mean, risk) =>
      risk?.resilience === "ì €ìœ„í—˜ì§‘ë‹¨",
    comment:
      "ğŸŒŸ í›Œë¥­í•©ë‹ˆë‹¤! í˜„ì¬ì˜ ê¸ì •ì ì¸ íšŒë³µ íƒ„ë ¥ì„±ì„ ê³„ì† ìœ ì§€í•´ ë³´ì„¸ìš”. ì‘ì›í•©ë‹ˆë‹¤!",
    style: "success"
  },
  // ...ë‚˜ë¨¸ì§€ RULES ê·¸ëŒ€ë¡œ...
  ...DIET_RULES,
  /* 7-A. ì•” ì´í›„ â€˜ì ˆì£¼â€™ ë¬¸í•­ì´ 3Â·4Â·5 â†’ ê¸ˆì£¼ ê¶Œì¥ */
  {
    id: "alcohol_warning",
    condition: (a) => {
      const v = Number(a.q32);          // "3" â†’ 3
      return v >= 3;                    // 3Â·4Â·5ì´ë©´ true
    },
    comment: "ğŸº ìˆ ì€ ì•” ì¬ë°œ ìœ„í—˜ì„ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸ˆì£¼ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.",
    style: "warning"
  },

  /* 7-B. ì•” ì´í›„ â€˜ê¸ˆì—°â€™ ë¬¸í•­ì´ 3Â·4Â·5 â†’ ê¸ˆì—° ê¶Œì¥ */
  {
    id: "smoke_warning",
    condition: (a) => {
      const v = Number(a.q33);
      return v >= 3;
    },
    comment: "ğŸš­ ë‹´ë°°ëŠ” ì•” ì¬ë°œ ìœ„í—˜ì„ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸ˆì—°ì„ ê¶Œì¥í•©ë‹ˆë‹¤.",
    style: "warning"
  }
];

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   4) ë‹¨ì¼ ì—”ì§„: answers â†’ ì½”ë©˜íŠ¸ ë°°ì—´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
export function getAdditionalFeedback(answers={}, mean={}, risk={}) {
  return FEEDBACK_RULES
    .filter(r => r.condition(answers, mean, risk))
    .map(r => ({ text:r.comment, style:r.style }));
}